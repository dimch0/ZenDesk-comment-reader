from zdesk import Zendesk
from pandas import DataFrame, ExcelWriter
from datetime import datetime
from iso8601
from pprint import pprint


def main():
    start_time = datetime.now()
    print "start", datetime.now()
    DOMAIN = 'MY_DOMAIN'
    USER = 'MY_USER'
    PWD = 'MY_PASSWORD'
    TIME_STRING = "time="

    zd = Zendesk(DOMAIN, USER, PWD)

    data_table= {}

    for ticket in zd.tickets_list()['tickets']:
        print "{0} Reading ticket: {1} ...".format(datetime.now(), ticket['id'])
        ticket_id = ticket['id']
        comments = zd.ticket_comments(ticket_id)['comments']
        private_comments = [comment for comment in comments if not comment['public']]
        for comment in private_comments:
            # print "COMMENT"
            # pprint(comment)
            # return False

            body = comment['body']
            ts_created = comment['created_at']
            print "DEBUG ts_created", ts_created
            print "DEBUG 2 iso8601", iso8601.parse_date(ts_created)
            return 1

            if TIME_STRING in comment['body']:
                body = body.replace("h", '')
                body = body.replace(TIME_STRING, '')

                if ticket_id not in data_table:
                    data_table[ticket_id] = [ticket_id, float(0.0), 'ongoing', ts_created]
                data_table[ticket_id][1] += float(body)

            if "billed" in body:
                if not ticket_id in data_table:
                    data_table[ticket_id] = [ticket_id, float(0.0), 'billed', ts_created]
                data_table[ticket_id][2] = "billed"

            if ticket['status'] == "closed":
                if not ticket_id in data_table:
                    data_table[ticket_id] = [ticket_id, float(0.0), 'closed', ts_created]
                data_table[ticket_id][2] = "closed"

    writer = ExcelWriter('billing_hours.xlsx')
    df = DataFrame(data_table).T
    print(df)
    df.to_excel(writer, 'Sheet1', header=["Ticket ID", "Hours", "Status", "Date"], index=False)
    writer.save()

    print "time taken:", datetime.now() - start_time

if __name__ == '__main__':
    main()
